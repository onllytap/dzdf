Playersaimbot = nil
local mouse = game.Players.LocalPlayer:GetMouse()
local guiservice = game:GetService("GuiService")
local players = game:GetService("Players")
local localPlayer = players.LocalPlayer
local currentCamera = game:GetService("Workspace").CurrentCamera
local circle = Drawing.new("Circle")

-- Vérification et suppression de l'ancienne GUI
if game:GetService("CoreGui"):FindFirstChild('infoplayers') then 
    game:GetService("CoreGui"):FindFirstChild('infoplayers'):Destroy()
end

-- Configuration de la GUI
local infoplayers = Instance.new("ScreenGui")
local Main = Instance.new("Frame")
local MainCorner = Instance.new("UICorner")
local Profile = Instance.new("Frame")
local ProfileCorner = Instance.new("UICorner")
local ImageProfile = Instance.new("ImageLabel")
local ImageProfileCorner = Instance.new("UICorner")
local HealthPlayers = Instance.new("TextLabel")
local NamePlayers = Instance.new("TextLabel")
local loackplayerslabel = Instance.new("TextLabel")
local Healthbar = Instance.new("Frame")
local HealthbarCorner = Instance.new("UICorner")
local Healthgreen = Instance.new("Frame")
local HealthgreenCorner = Instance.new("UICorner")

infoplayers.Name = "infoplayers"
infoplayers.Parent = game:GetService("CoreGui")
infoplayers.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

Main.Name = "Main"
Main.Parent = infoplayers
Main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Main.Position = UDim2.new(0.01, 0, 0.3, 0)
Main.Size = UDim2.new(0, 263, 0, 120)

MainCorner.Name = "MainCorner"
MainCorner.Parent = Main

-- Configuration de la hitbox avec une taille réduite et logique
function adjustHitbox(player)
    pcall(function()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            player.Character.HumanoidRootPart.Size = Vector3.new(5, 5, 5) -- Taille réduite
            player.Character.HumanoidRootPart.Transparency = 0.5
            player.Character.HumanoidRootPart.CanCollide = false
        end
    end)
end

function resetHitbox(player)
    pcall(function()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            player.Character.HumanoidRootPart.Size = Vector3.new(2, 2, 1) -- Taille normale
            player.Character.HumanoidRootPart.Transparency = 0
            player.Character.HumanoidRootPart.CanCollide = true
        end
    end)
end

-- Mise à jour du cercle pour le Silent Aim
function updateCircle(Fov, colorCircle)
    if circle.__OBJECT_EXISTS then
        circle.Transparency = 1
        circle.Visible = true
        circle.Thickness = 2
        circle.Color = colorCircle
        circle.NumSides = 100
        circle.Radius = (Fov * 6) / 2
        circle.Filled = false
        circle.Position = Vector2.new(mouse.X, mouse.Y + guiservice:GetGuiInset().Y)
    end
end

-- Gestion des joueurs et de leur sélection
spawn(function()
    while wait(0.1) do
        for _, player in pairs(players:GetPlayers()) do
            if player ~= localPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local pos = currentCamera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
                local magnitude = (Vector2.new(pos.X, pos.Y) - Vector2.new(mouse.X, mouse.Y)).Magnitude

                if magnitude < (getgenv().setting['Fov'] * 6 - 8) / 2 then
                    if (player.Character.HumanoidRootPart.Position - localPlayer.Character.HumanoidRootPart.Position).Magnitude <= 1000 then
                        if not getgenv().setting['LockPlayers'] then
                            Playersaimbot = player.Name
                            PlayersPosition = player.Character.HumanoidRootPart.Position
                            adjustHitbox(player)
                        end
                    end
                else
                    resetHitbox(player)
                end
            end
        end
    end
end)

-- Amélioration de la gestion des tirs automatiques
mouse.Button1Down:Connect(function()
    pcall(function()
        if Playersaimbot ~= nil then
            local target = game.Players:FindFirstChild(Playersaimbot)
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                local args = {
                    [1] = PlayersPosition,
                    [2] = target.Character.HumanoidRootPart
                }
                local tool = localPlayer.Character:FindFirstChildOfClass("Tool")
                if tool and tool:FindFirstChild("RemoteFunctionShoot") then
                    tool.RemoteFunctionShoot:InvokeServer(unpack(args))
                end
            end
        end
    end)
end)

-- Ajout d'un mécanisme pour nettoyer après le déblocage
game:GetService("UserInputService").InputBegan:Connect(function(io, p)
    if io.KeyCode == getgenv().setting['LockPlayersBind'] then
        if getgenv().setting['LockPlayers'] then
            loackplayerslabel.Text = "Lock Players | OFF"
            getgenv().setting['LockPlayers'] = false
        else
            loackplayerslabel.Text = "Lock Players | ON"
            getgenv().setting['LockPlayers'] = true
        end
    end

    if io.KeyCode == getgenv().setting['resetPlayersBind'] then
        Playersaimbot = nil
        PlayersPosition = nil
        ImageProfile.Image = ''
        NamePlayers.Text = "Name | N/A"
        HealthPlayers.Text = "Health | N/A"
    end
end)
